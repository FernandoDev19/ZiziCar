<div class="container mx-auto p-0 md:p-4">
  <div class="flex flex-col md:flex-row gap-8">
    <!-- Lado izquierdo-->
    <app-details-request
      [dataForRequestInformation]="dataForRequestInformation"
      class="w-full md:w-1/2"
    ></app-details-request>

    <!-- Lado derecho -->
    <div class="w-full md:w-1/2">
      <h1 class="text-3xl text-gray-600 font-extrabold mb-6">Cotizar</h1>
      <form [formGroup]="formAnswer" class="space-y-6">
        <!-- Título -->
        <h2 class="text-xl font-bold text-gray-600 mb-4">
          {{ currentCategory.label }}
        </h2>

        <!-- Campos -->
        <div *ngFor="let field of currentCategory.fields" class="space-y-2">
          <label [for]="field.name" class="block font-medium text-gray-600">
            <!-- Labels -->
            @if(field.name === 'rent'){
              <div class="w-full">
                  @if(valuePerDay){
                    <div class="inline-block w-1/2">{{ field.label }}</div>
                  }@else {
                    <div class="inline-block w-1/2">Valor total de renta $</div>
                  }
                  <div class="inline-block w-1/2 text-center md:text-start">Medio de pago</div>
              </div>
            }@else if(field.type != 'p' && field.type != 'checkbox'){
              {{ field.label }}
            }
          </label>

          <!-- Inputs - Buttons - Checks - etc -->
          @if(field.type === 'text'){
              @if(field.action === 'formatInput'){
                @if(field.name === 'rent'){
                  @if(valuePerDay){
                  <div class="flex w-full">
                    <input
                      type="text"
                      id="rent"
                      name="rent"
                      [placeholder]="field.options.placeholder || ''"
                      (input)="formatInput('rentPerDay', $event)"
                      formControlName="rent"
                      class="block w-1/2 border border-gray-300 rounded-l-md p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      maxlength="13"
                    />
                    <div class="w-1/2">
                      <input
                        type="text"
                        id="allowed_payment_method"
                        name="allowed_payment_method"
                        formControlName="allowed_payment_method"
                        (click)="showOverlay($event, 'allowed_payment_method')"
                        class="block w-full border border-gray-300 rounded-r-md p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        readonly
                      />
                    </div>
                    <p-overlayPanel
                      #overlayPaymentMethod
                      [style]="{
                        width: overlayWidth,
                        maxHeight: overlayMaxHeight,
                        overflowY: 'scroll'
                      }"
                    >
                      <div class="flex flex-col sm:flex-row">
                        <div class="w-full">
                          <ul class="list-none p-2 w-full">
                            <li
                              class="p-2 hover:bg-gray-200 hover:rounded-md cursor-pointer flex items-center"
                              *ngFor="let paymentMethod of allowedPaymentMethodsList"
                              (click)="selectCategory(paymentMethod, 'paymentMethod')"
                            >
                              {{ paymentMethod }}
                            </li>
                          </ul>
                        </div>
                      </div>
                    </p-overlayPanel>
                  </div>
                  <div
                    class="mt-2 p-2 bg-green-100 border border-green-400 text-green-800 rounded-lg"
                  >
                    <p class="text-gray-600 text-sm">
                      <strong
                        >Valor total para
                        {{ dataForRequestInformation.days_of_rent }} días:</strong
                      >
                      {{
                        totalValueOfRentPerDay || 0
                          | currency : "COP" : "symbol" : "1.0-0"
                      }}
                    </p>
                  </div>
                  }@else {
                <div class="flex w-full">
                  <input
                    type="text"
                    id="rent"
                    name="rent"
                    (input)="formatInput('rent', $event)"
                    formControlName="rent"
                    class="block w-1/2 border border-gray-300 rounded-l-md p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    maxlength="13"
                  />
                  <div class="w-1/2">
                    <input
                      type="text"
                      id="allowed_payment_method"
                      name="allowed_payment_method"
                      formControlName="allowed_payment_method"
                      (click)="showOverlay($event, 'allowed_payment_method')"
                      class="block w-full border border-gray-300 rounded-r-md p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      readonly
                    />
                  </div>
                  <p-overlayPanel
                    #overlayPaymentMethod
                    [style]="{
                      width: overlayWidth,
                      maxHeight: overlayMaxHeight,
                      overflowY: 'scroll'
                    }"
                  >
                    <div class="flex flex-col sm:flex-row">
                      <div class="w-full">
                        <ul class="list-none p-2 w-full">
                          <li
                            class="p-2 hover:bg-gray-200 hover:rounded-md cursor-pointer flex items-center"
                            *ngFor="let paymentMethod of allowedPaymentMethodsList"
                            (click)="selectCategory(paymentMethod, 'paymentMethod')"
                          >
                            {{ paymentMethod }}
                          </li>
                        </ul>
                      </div>
                    </div>
                  </p-overlayPanel>
                </div>
                  }
                }@else{
              <input
                [type]="field.type"
                [id]="field.name"
                [name]="field.name"
                (input)="formatInput(field.name, $event)"
                formControlName="{{ field.name }}"
                class="block w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                maxlength="13"
                [readonly]="field.options.readonly"
              />
                }
              }@else if(field.action === 'showOverlay'){
              <input
                [type]="field.type"
                [id]="field.name"
                [name]="field.name"
                formControlName="{{ field.name }}"
                (click)="showOverlay($event, field.name)"
                class="block w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                [placeholder]="field.options.placeholder || ''"
                [readonly]="field.options.readonly"
              />
              }@else{
              <input
                [type]="field.type"
                [id]="field.name"
                [name]="field.name"
                formControlName="{{ field.name }}"
                class="block w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                [readonly]="field.options.readonly"
              />
              }
          }@else if(field.type === 'p'){
            @if(field.action === 'percentageInValues'){
              <div class="flex gap-3">
                <p class="text-gray-600 text-sm">
                  <strong>Valor total</strong>
                  {{
                    valorTotal | currency : "COP" : "symbol" : "1.0-0"
                  }}
                </p>
                <p class="text-gray-600 text-sm">
                  <strong>{{ field.label }}</strong>-{{ percentageInValues | currency : "COP" : "symbol" : "1.0-0" }}
                  ({{ formAnswer.get("percentage_of_total_value")?.value }})
                </p>
              </div>
              <div class="mt-2 p-2 bg-gray-100 border border-gray-300 rounded-lg">
                <p class="text-gray-600">
                  <strong>Total a cobrar cliente</strong>
                  {{
                    valorTotal - percentageInValues | currency : "COP" : "symbol" : "1.0-0"
                  }}
                </p>
              </div>
            }@else if(field.action === 'totalValue'){
              <div class="mt-2 p-2 bg-gray-700 rounded-lg text-gray-200">
                <p class="text-gray-100">
                  <strong>{{ field.label }} </strong>
                  {{ valorTotal | currency : "COP" : "symbol" : "1.0-0" }}
                </p>
              </div>
            }
          }@else if(field.type === 'textarea'){
              <textarea
                [name]="field.name"
                [id]="field.name"
                formControlName="{{ field.name }}"
                class="block w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                rows="4"
                [readonly]="field.options.readonly"
              ></textarea>
          }@else if(field.type === 'button'){
            @if(field.action === 'typeOfCalculation'){
                <div class="flex gap-3">
                  <button
                    [type]="field.type"
                    [disabled]="valuePerDay"
                    (click)="toggleTypeOfCalculation()"
                    [ngClass]="{
                      'bg-blue-400': valuePerDay,
                      'bg-white hover:bg-gray-100': !valuePerDay
                    }"
                    class="px-3 py-2 border rounded-md text-gray-700"
                  >
                    Valor × día
                  </button>
                  <button
                    [type]="field.type"
                    [disabled]="!valuePerDay"
                    (click)="toggleTypeOfCalculation()"
                    [ngClass]="{
                      'bg-blue-400': !valuePerDay,
                      'bg-white hover:bg-gray-100': valuePerDay
                    }"
                    class="px-3 py-2 border rounded-md text-gray-700"
                  >
                    Valor total
                  </button>
                </div>
            }
          }@else if(field.type === 'checkbox'){
            @if(field.action === 'garantia'){
              <div class="flex gap-3">
                @if(field.options.checkboxs.length > 0){
                  @for (checkbox of field.options.checkboxs; track $index) {
                    <div class="flex items-center">
                      <p-checkbox class="border" (onChange)="onCheckboxChange('warranty', checkbox.label, $event)" [inputId]="checkbox.name" [name]="checkbox.name" [value]="checkbox.label" />
                      <label [for]="checkbox.name" class="ml-2"> {{ checkbox.label }} </label>
                    </div>
                  }
                }
              </div>
              <p *ngIf="paymentMethodRequired" class="text-sm text-red-400">Selecciona un metodo de pago</p>
            }
          }@else {
              <div class="flex items-center">
                <p-checkbox [inputId]="field.name" [name]="field.name" [value]="field.label" />
                <label [for]="field.name" class="ml-2"> {{ field.label }} </label>
              </div>
          }

          <!-- Errors -->
          @if(formAnswer.get(field.name)?.invalid && formAnswer.get(field.name)?.touched){
            @if(formAnswer.get(field.name)?.errors?.['required']){
              <p class="text-sm text-red-500 m-0">Este campo es obligatorio</p>
            }@else if (formAnswer.get(field.name)?.errors?.['min']) {
              <p class="text-sm text-red-500 m-0">Mínimo 10 (COP / USD)</p>
            }
          }

          <!-- Overlays -->
          @if(field.name === 'brand'){
            <p-overlayPanel
              #overlayBrand
              [style]="{
                width: overlayWidth,
                maxHeight: overlayMaxHeight,
                overflowY: 'scroll'
              }"
            >
              <div class="flex flex-col sm:flex-row">
                <div class="w-full">
                  <ul class="list-none p-2 w-full">
                    <li
                      class="p-2 hover:bg-gray-200 hover:rounded-md cursor-pointer flex items-center"
                      *ngFor="let brand of brandsList"
                      (click)="selectCategory(brand, 'brand')"
                    >
                      {{ brand }}
                    </li>
                  </ul>
                </div>
              </div>
            </p-overlayPanel>
          }@else if(field.name === 'transmission'){
            <p-overlayPanel
              #overlayTransmission
              [style]="{
                width: overlayWidth,
                maxHeight: overlayMaxHeight,
                overflowY: 'scroll'
              }"
            >
              <div class="flex flex-col sm:flex-row">
                <!-- Lista de opciones para el tipo de transmisión -->
                <div class="w-full sm:w-1/2">
                  <ul class="list-none p-2 w-full">
                    <li
                      class="p-2 hover:bg-gray-200 hover:rounded-md cursor-pointer flex items-center"
                      *ngFor="let transmission of transmissionsList"
                      (mouseenter)="
                        setHoveredImage('transmission', transmission.image_url)
                      "
                      (click)="selectCategory(transmission.name, 'transmission')"
                    >
                      <i class="fa-solid fa-gears text-gray-500 mr-2"></i>
                      {{ transmission.name }}
                    </li>
                  </ul>
                </div>
                <!-- Imagen que se muestra cuando se selecciona un tipo de transmisión -->
                <div
                  [ngClass]="{ hidden: !imageTransmission || isMobile }"
                  class="w-1/2 flex items-center justify-center"
                >
                  <img
                    [ngClass]="{ hidden: imageTransmission == null }"
                    [src]="imageTransmission"
                    alt="Tipo de transmisión"
                    class="max-w-full"
                    style="max-height: 150px"
                  />
                </div>
              </div>
            </p-overlayPanel>
          }@else if(field.name === 'model'){
            <p-overlayPanel
              #overlayModel
              [style]="{
                width: overlayWidth,
                maxHeight: overlayMaxHeight,
                overflowY: 'scroll'
              }"
            >
              <div class="flex flex-col sm:flex-row">
                <div class="w-full">
                  <ul class="list-none p-2 w-full">
                    <li
                      class="p-2 hover:bg-gray-200 hover:rounded-md cursor-pointer flex items-center"
                      *ngFor="let model of modelsList"
                      (click)="selectCategory(model, 'model')"
                    >
                      {{ model }} En adelante
                    </li>
                  </ul>
                </div>
              </div>
            </p-overlayPanel>
          }@else if(field.name === 'fuel'){
            <p-overlayPanel
              #overlayFuel
              [style]="{
                width: overlayWidth,
                maxHeight: overlayMaxHeight,
                overflowY: 'scroll'
              }"
            >
              <div class="flex flex-col sm:flex-row">
                <div class="w-full">
                  <ul class="list-none p-2 w-full">
                    <li
                      class="p-2 hover:bg-gray-200 hover:rounded-md cursor-pointer flex items-center"
                      *ngFor="let fuel of fuelsList"
                      (click)="selectCategory(fuel, 'fuel')"
                    >
                      {{ fuel }}
                    </li>
                  </ul>
                </div>
              </div>
            </p-overlayPanel>
          }@else if (field.name === 'color'){
            <p-overlayPanel
              #overlayColor
              [style]="{
                width: overlayWidth,
                maxHeight: overlayMaxHeight,
                overflowY: 'scroll'
              }"
            >
              <div class="flex flex-col sm:flex-row">
                <div class="w-full">
                  <ul class="list-none p-2 w-full">
                    <li
                      class="p-2 hover:bg-gray-200 hover:rounded-md cursor-pointer flex items-center"
                      *ngFor="let color of colorsList"
                      (click)="selectCategory(color, 'color')"
                    >
                      {{ color }}
                    </li>
                  </ul>
                </div>
              </div>
            </p-overlayPanel>
          }@else if(field.name === 'plate_end_in'){
            <p-overlayPanel
              #overlayPlate
              [style]="{
                width: overlayWidth,
                maxHeight: overlayMaxHeight,
                overflowY: 'scroll'
              }"
            >
              <div class="flex flex-col sm:flex-row">
                <div class="w-full">
                  <ul class="list-none p-2 w-full">
                    <li
                      class="p-2 hover:bg-gray-200 hover:rounded-md cursor-pointer flex items-center"
                      *ngFor="let plate of platesList"
                      (click)="selectCategory(plate, 'plate')"
                    >
                      {{ plate }}
                    </li>
                  </ul>
                </div>
              </div>
            </p-overlayPanel>
          }
        </div>

        <!-- Paginación -->
        <div class="flex justify-between items-center mt-6">
          <button
            type="button"
            class="px-4 py-2 bg-blue-400 text-gray-700 border border-gray-300 rounded-md disabled:opacity-50"
            (click)="prevPage()"
            [disabled]="currentPage === 1"
          >
            < Atrás
          </button>
          <span>Página {{ currentPage }} de {{ totalPages }}</span>
          <button
            type="button"
            class="px-4 py-2 bg-blue-400 text-gray-700 border border-gray-300 rounded-md disabled:opacity-50"
            (click)="nextPage()"
            [disabled]="currentPage === totalPages"
            *ngIf="currentPage < totalPages"
          >
            Siguiente >
          </button>
          <button
            type="submit"
            [disabled]="formAnswer.invalid"
            (click)="createQuote()"
            *ngIf="currentPage === totalPages"
            class="bg-pink-500 disabled:opacity-50 transition-all duration-200 ease text-white px-4 py-2 rounded-md"
          >
            Cotizar
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
